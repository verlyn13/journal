name: Frontend Build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5
        with:
          bun-version: latest

      - name: Cache bun store
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}

      - name: Install deps
        run: bun install

      - name: Env sanity (no secrets)
        run: |
          echo "MODE=$MODE"
          echo "VITE_BASE=${VITE_BASE:-/}"
          echo "CI=$CI"

      - name: Vite debug build
        env:
          CI: "true"
          VITE_LOG_LEVEL: debug
        run: bun x vite build --debug || (echo "==== Vite config dump ====" && node -e "import('./vite.config.ts').then(v=>console.log(v.default))" && exit 1)

      - name: Upload dist (on failure too)
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: web-dist-or-logs
          path: |
            apps/web/dist
            apps/web/.vite/deps
          if-no-files-found: ignore