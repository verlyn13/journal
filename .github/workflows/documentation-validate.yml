# .github/workflows/documentation-validate.yml
name: Documentation Structure Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'scripts/**'
      - '.github/workflows/documentation-validate.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'scripts/**'
      - '.github/workflows/documentation-validate.yml'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  validate-structure:
    name: Validate Documentation Structure
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python with uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "0.5.16"

    - name: Install dependencies
      working-directory: apps/api
      run: uv sync --all-extras --dev

    - name: Validate documentation with schema
      run: |
        echo "Validating documentation against JSON schemas..."
        cd apps/api && uv run python ../../scripts/validate_docs.py

    - name: Check documentation coverage
      run: |
        echo "Checking documentation coverage..."
        cd apps/api && uv run python ../../scripts/check_doc_coverage.py

    - name: Generate documentation report
      run: |
        echo "Generating documentation report..."
        cd apps/api && uv run python ../../scripts/generate_doc_report.py

    - name: Upload documentation report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: documentation-report
        path: docs/_generated/reports/

    # Keep legacy checks temporarily (non-blocking)
    - name: Validate frontmatter (legacy)
      continue-on-error: true
      run: |
        echo "Validating markdown frontmatter (legacy check)..."
        cd apps/api && uv run python ../../scripts/validate_docs_frontmatter.py || true

    - name: Check documentation structure (legacy)
      continue-on-error: true
      run: |
        echo "Checking documentation structure (legacy check)..."
        cd apps/api && uv run python ../../scripts/check_docs_structure.py || true