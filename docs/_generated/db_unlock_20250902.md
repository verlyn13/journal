INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:\*\*\*@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=alembic-journal-dev2
Traceback (most recent call last):
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in \_exec\_single\_context
self.dialect.do\_execute(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
cursor, str\_statement, effective\_parameters, context
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/default.py", line 951, in do\_execute
cursor.execute(statement, parameters)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^^^^^
psycopg2.errors.DuplicateColumn: column "word\_count" of relation "entries" already exists

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/alembic", line 10, in <module>
sys.exit(main())
\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 1022, in main
CommandLine(prog=prog).main(argv=argv)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 1012, in main
self.run\_cmd(cfg, options)
\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 946, in run\_cmd
fn(
\~\~^
config,
^^^^^^^
\*\[getattr(options, k, None) for k in positional],
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
\*\*{k: getattr(options, k, None) for k in kwarg},
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/command.py", line 483, in upgrade
script.run\_env()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/script/base.py", line 549, in run\_env
util.load\_python\_file(self.dir, "env.py")
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/util/pyfiles.py", line 116, in load\_python\_file
module = load\_module\_py(module\_id, path)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/util/pyfiles.py", line 136, in load\_module\_py
spec.loader.exec\_module(module)  # type: ignore
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^
File "<frozen importlib._bootstrap_external>", line 1026, in exec\_module
File "<frozen importlib._bootstrap>", line 488, in \_call\_with\_frames\_removed
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/alembic/env.py", line 116, in <module>
run\_migrations\_online()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/alembic/env.py", line 108, in run\_migrations\_online
context.run\_migrations()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "<string>", line 8, in run\_migrations
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/runtime/environment.py", line 946, in run\_migrations
self.get\_context().run\_migrations(\*\*kw)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/runtime/migration.py", line 627, in run\_migrations
step.migration\_fn(\*\*kw)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/alembic/versions/0005\_add\_content\_metrics.py", line 21, in upgrade
op.add\_column("entries", sa.Column("word\_count", sa.Integer(), nullable=False, server\_default="0"))
\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "<string>", line 8, in add\_column
File "<string>", line 3, in add\_column
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/operations/ops.py", line 2186, in add\_column
return operations.invoke(op)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/operations/base.py", line 441, in invoke
return fn(self, operation)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/operations/toimpl.py", line 175, in add\_column
operations.impl.add\_column(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
table\_name,
^^^^^^^^^^^
...<3 lines>...
\*\*kw,
^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/ddl/impl.py", line 378, in add\_column
self.\_exec(
\~\~\~\~\~\~\~\~\~\~^
base.AddColumn(
^^^^^^^^^^^^^^^
...<4 lines>...
)
^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/ddl/impl.py", line 246, in \_exec
return conn.execute(construct, params)
\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
return meth(
self,
distilled\_parameters,
execution\_options or NO\_OPTIONS,
)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/sql/ddl.py", line 187, in \_execute\_on\_connection
return connection.\_execute\_ddl(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
self, distilled\_params, execution\_options
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1530, in \_execute\_ddl
ret = self.\_execute\_context(
dialect,
...<4 lines>...
compiled,
)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in \_execute\_context
return self.\_exec\_single\_context(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
dialect, context, statement, parameters
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in \_exec\_single\_context
self.\_handle\_dbapi\_exception(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
e, str\_statement, effective\_parameters, cursor, context
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 2355, in \_handle\_dbapi\_exception
raise sqlalchemy\_exception.with\_traceback(exc\_info\[2]) from e
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in \_exec\_single\_context
self.dialect.do\_execute(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
cursor, str\_statement, effective\_parameters, context
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/default.py", line 951, in do\_execute
cursor.execute(statement, parameters)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.DuplicateColumn) column "word\_count" of relation "entries" already exists

\[SQL: ALTER TABLE entries ADD COLUMN word\_count INTEGER DEFAULT '0' NOT NULL]
(Background on this error at: <https://sqlalche.me/e/20/f405>)
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Running stamp\_revision  -> 0005\_add\_content\_metrics
INFO  \[alembic.runtime.migration] Running stamp\_revision  -> 0005\_add\_content\_metrics
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:***@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=alembic-journal-dev2
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:***@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=alembic-journal-dev2
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_online\_add\_version\_and\_metrics, Online-safe add version and metrics columns
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_online\_add\_version\_and\_metrics, Online-safe add version and metrics columns
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:\*\*\*@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=alembic-journal-dev2
\[migration] Column entries.version already exists, skipping
\[migration] Column entries.word\_count already exists, skipping
\[migration] Column entries.char\_count already exists, skipping
Traceback (most recent call last):
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in \_exec\_single\_context
self.dialect.do\_execute(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
cursor, str\_statement, effective\_parameters, context
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/default.py", line 951, in do\_execute
cursor.execute(statement, parameters)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^^^^^
psycopg2.errors.StringDataRightTruncation: value too long for type character varying(32)

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/alembic", line 10, in <module>
sys.exit(main())
\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 1022, in main
CommandLine(prog=prog).main(argv=argv)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 1012, in main
self.run\_cmd(cfg, options)
\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 946, in run\_cmd
fn(
\~\~^
config,
^^^^^^^
\*\[getattr(options, k, None) for k in positional],
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
\*\*{k: getattr(options, k, None) for k in kwarg},
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/command.py", line 483, in upgrade
script.run\_env()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/script/base.py", line 549, in run\_env
util.load\_python\_file(self.dir, "env.py")
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/util/pyfiles.py", line 116, in load\_python\_file
module = load\_module\_py(module\_id, path)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/util/pyfiles.py", line 136, in load\_module\_py
spec.loader.exec\_module(module)  # type: ignore
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^
File "<frozen importlib._bootstrap_external>", line 1026, in exec\_module
File "<frozen importlib._bootstrap>", line 488, in *call\_with\_frames\_removed
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/alembic/env.py", line 116, in <module>
run\_migrations\_online()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/alembic/env.py", line 108, in run\_migrations\_online
context.run\_migrations()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "<string>", line 8, in run\_migrations
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/runtime/environment.py", line 946, in run\_migrations
self.get\_context().run\_migrations(\*\*kw)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/runtime/migration.py", line 634, in run\_migrations
head\_maintainer.update\_to\_step(step)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/runtime/migration.py", line 866, in update\_to\_step
self.*update\_version(from*, to*)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/runtime/migration.py", line 801, in \_update\_version
ret = self.context.impl.\_exec(
self.context.\_version.update()
...<4 lines>...
)
)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/ddl/impl.py", line 246, in \_exec
return conn.execute(construct, params)
\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
return meth(
self,
distilled\_parameters,
execution\_options or NO\_OPTIONS,
)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/sql/elements.py", line 526, in \_execute\_on\_connection
return connection.\_execute\_clauseelement(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
self, distilled\_params, execution\_options
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in \_execute\_clauseelement
ret = self.\_execute\_context(
dialect,
...<8 lines>...
cache\_hit=cache\_hit,
)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in \_execute\_context
return self.\_exec\_single\_context(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
dialect, context, statement, parameters
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in \_exec\_single\_context
self.\_handle\_dbapi\_exception(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
e, str\_statement, effective\_parameters, cursor, context
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 2355, in \_handle\_dbapi\_exception
raise sqlalchemy\_exception.with\_traceback(exc\_info\[2]) from e
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in \_exec\_single\_context
self.dialect.do\_execute(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
cursor, str\_statement, effective\_parameters, context
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/default.py", line 951, in do\_execute
cursor.execute(statement, parameters)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.DataError: (psycopg2.errors.StringDataRightTruncation) value too long for type character varying(32)

\[SQL: UPDATE alembic\_version SET version\_num='0006\_online\_add\_version\_and\_metrics' WHERE alembic\_version.version\_num = '0005\_add\_content\_metrics']
(Background on this error at: <https://sqlalche.me/e/20/9h9h>)
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_add\_metrics\_safe, Online-safe add version and metrics columns
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_add\_metrics\_safe, Online-safe add version and metrics columns
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:\*\*\*@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=alembic-journal-dev2
\[migration] Column entries.version already exists, skipping
\[migration] Column entries.word\_count already exists, skipping
\[migration] Column entries.char\_count already exists, skipping
Did not find any relation named "entries".
Did not find any relations.
tablename
---------

(0 rows)

INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:***@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=alembic-journal-dev2
ERROR:  DROP DATABASE cannot run inside a transaction block
CREATE DATABASE
\[alembic] Using settings.db\_url: postgresql+asyncpg://journal:journal\@localhost:5433/journal
\[alembic] Converted driver to sync: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:***@localhost:5433/journal
\[alembic] driver=postgresql+psycopg2, host=localhost, database=journal
Traceback (most recent call last):
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 143, in **init**
self.\_dbapi\_connection = engine.raw\_connection()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 3301, in raw\_connection
return self.pool.connect()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 447, in connect
return \_ConnectionFairy.\_checkout(self)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 1264, in \_checkout
fairy = \_ConnectionRecord.checkout(pool)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 711, in checkout
rec = pool.\_do\_get()
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/impl.py", line 306, in \_do\_get
return self.\_create\_connection()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 388, in \_create\_connection
return \_ConnectionRecord(self)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 673, in **init**
self.\_\_connect()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 899, in \_\_connect
with util.safe\_reraise():
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in **exit**
raise exc\_value.with\_traceback(exc\_tb)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 895, in \_\_connect
self.dbapi\_connection = connection = pool.\_invoke\_creator(self)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/create.py", line 661, in connect
return dialect.connect(\*cargs, \*\*cparams)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/default.py", line 629, in connect
return self.loaded\_dbapi.connect(\*cargs, \*\*cparams)  # type: ignore\[no-any-return]  # NOQA: E501
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/psycopg2/**init**.py", line 122, in connect
conn = \_connect(dsn, connection\_factory=connection\_factory, \*\*kwasync)
psycopg2.OperationalError: connection to server at "localhost" (::1), port 5433 failed: FATAL:  password authentication failed for user "journal"

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/alembic", line 10, in <module>
sys.exit(main())
\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 1022, in main
CommandLine(prog=prog).main(argv=argv)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 1012, in main
self.run\_cmd(cfg, options)
\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/config.py", line 946, in run\_cmd
fn(
\~\~^
config,
^^^^^^^
\*\[getattr(options, k, None) for k in positional],
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
\*\*{k: getattr(options, k, None) for k in kwarg},
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/command.py", line 483, in upgrade
script.run\_env()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/script/base.py", line 549, in run\_env
util.load\_python\_file(self.dir, "env.py")
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/util/pyfiles.py", line 116, in load\_python\_file
module = load\_module\_py(module\_id, path)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/alembic/util/pyfiles.py", line 136, in load\_module\_py
spec.loader.exec\_module(module)  # type: ignore
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^
File "<frozen importlib._bootstrap_external>", line 1026, in exec\_module
File "<frozen importlib._bootstrap>", line 488, in \_call\_with\_frames\_removed
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/alembic/env.py", line 116, in <module>
run\_migrations\_online()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/alembic/env.py", line 94, in run\_migrations\_online
with connectable.connect() as connection:
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 3277, in connect
return self.\_connection\_cls(self)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 145, in **init**
Connection.\_handle\_dbapi\_exception\_noconnection(
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^
err, dialect, engine
^^^^^^^^^^^^^^^^^^^^
)
^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 2440, in \_handle\_dbapi\_exception\_noconnection
raise sqlalchemy\_exception.with\_traceback(exc\_info\[2]) from e
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 143, in **init**
self.\_dbapi\_connection = engine.raw\_connection()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py", line 3301, in raw\_connection
return self.pool.connect()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 447, in connect
return \_ConnectionFairy.\_checkout(self)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 1264, in \_checkout
fairy = \_ConnectionRecord.checkout(pool)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 711, in checkout
rec = pool.\_do\_get()
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/impl.py", line 306, in \_do\_get
return self.\_create\_connection()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 388, in \_create\_connection
return \_ConnectionRecord(self)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 673, in **init**
self.\_\_connect()
\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 899, in \_\_connect
with util.safe\_reraise():
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in **exit**
raise exc\_value.with\_traceback(exc\_tb)
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/pool/base.py", line 895, in \_\_connect
self.dbapi\_connection = connection = pool.\_invoke\_creator(self)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/create.py", line 661, in connect
return dialect.connect(\*cargs, \*\*cparams)
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/sqlalchemy/engine/default.py", line 629, in connect
return self.loaded\_dbapi.connect(\*cargs, \*\*cparams)  # type: ignore\[no-any-return]  # NOQA: E501
\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^^^^^^^^^^^^^^^^^^^
File "/home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/lib64/python3.13/site-packages/psycopg2/**init**.py", line 122, in connect
conn = \_connect(dsn, connection\_factory=connection\_factory, \*\*kwasync)
sqlalchemy.exc.OperationalError: (psycopg2.OperationalError) connection to server at "localhost" (::1), port 5433 failed: FATAL:  password authentication failed for user "journal"

(Background on this error at: <https://sqlalche.me/e/20/e3q8>)
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_add\_metrics\_safe, Online-safe add version and metrics columns
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_add\_metrics\_safe, Online-safe add version and metrics columns
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:***@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=
\[migration] Column entries.version already exists, skipping
\[migration] Column entries.word\_count already exists, skipping
\[migration] Column entries.char\_count already exists, skipping
Did not find any relation named "entries".
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:***@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=
\[migration 0001] Creating pgvector extension
\[migration 0001] Creating entries table
Did not find any relations.
schemaname | tablename | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity
\------------+-----------+------------+------------+------------+----------+-------------+-------------
(0 rows)

INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_add\_metrics\_safe, Online-safe add version and metrics columns
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_add\_metrics\_safe, Online-safe add version and metrics columns
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_dev2
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:\*\*\*@127.0.0.1:5433/journal\_dev2
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_dev2
\[alembic] current\_database=journal\_dev2
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=
\[migration 0001] Creating pgvector extension
\[migration 0001] Creating entries table
\[migration] Column entries.version already exists, skipping
\[migration] Column entries.word\_count already exists, skipping
\[migration] Column entries.char\_count already exists, skipping
List of relations
Schema |       Name       | Type  |  Owner\
\--------+------------------+-------+---------
public | alembic\_version  | table | journal
public | entries          | table | journal
public | entry\_embeddings | table | journal
public | events           | table | journal
(4 rows)

```
                                                                                                 Table "public.entries"
  Column      |           Type           | Collation | Nullable |                                                                          Default                                                                           
```

\------------------+--------------------------+-----------+----------+------------------------------------------------------------------------------------------------------------------------------------------------------------
id               | uuid                     |           | not null |
title            | character varying        |           | not null |
content          | text                     |           | not null |
author\_id        | uuid                     |           | not null |
created\_at       | timestamp with time zone |           | not null | now()
updated\_at       | timestamp with time zone |           | not null | now()
word\_count       | integer                  |           | not null | 0
is\_deleted       | boolean                  |           | not null | false
search\_vector    | tsvector                 |           |          | generated always as (to\_tsvector('english'::regconfig, (COALESCE(title, ''::character varying)::text || ' '::text) || COALESCE(content, ''::text))) stored
markdown\_content | text                     |           |          |
content\_version  | integer                  |           | not null | 1
version          | integer                  |           | not null | 1
char\_count       | integer                  |           | not null | 0
Indexes:
"entries\_pkey" PRIMARY KEY, btree (id)
"idx\_entries\_content\_version" btree (content\_version)
"ix\_entries\_author\_created" btree (author\_id, created\_at)
"ix\_entries\_author\_id" btree (author\_id)
"ix\_entries\_created\_at" btree (created\_at)
"ix\_entries\_is\_deleted" btree (is\_deleted)
"ix\_entries\_not\_deleted\_created" btree (created\_at) WHERE is\_deleted = false
"ix\_entries\_search\_vector" gin (search\_vector)
Referenced by:
TABLE "entry\_embeddings" CONSTRAINT "entry\_embeddings\_entry\_id\_fkey" FOREIGN KEY (entry\_id) REFERENCES entries(id) ON DELETE CASCADE

count | min | max
\-------+-----+-----
0 |     |\
(1 row)

ERROR: usage: pytest \[options] \[file\_or\_dir] \[file\_or\_dir] \[...]
pytest: error: unrecognized arguments: -n
inifile: /home/verlyn13/Projects/verlyn13/journal/apps/api/pyproject.toml
rootdir: /home/verlyn13/Projects/verlyn13/journal/apps/api

\============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-8.4.1, pluggy-1.6.0 -- /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3
cachedir: .pytest\_cache
rootdir: /home/verlyn13/Projects/verlyn13/journal/apps/api
configfile: pyproject.toml
testpaths: tests
plugins: asyncio-1.1.0, cov-6.2.1, anyio-4.10.0, Faker-37.6.0, timeout-2.4.0
asyncio: mode=Mode.AUTO, asyncio\_default\_fixture\_loop\_scope=None, asyncio\_default\_test\_loop\_scope=function
collecting ... collected 171 items

tests/api/test\_admin.py::TestAdminAPI::test\_admin\_ping PASSED
tests/api/test\_admin.py::TestAdminAPI::test\_admin\_health PASSED
tests/api/test\_admin.py::TestAdminAPI::test\_admin\_endpoints\_unauthorized PASSED
tests/api/test\_admin.py::TestAdminAPI::test\_health\_check\_with\_db\_failure PASSED
tests/api/test\_admin.py::TestAdminAPI::test\_reindex\_embeddings\_endpoint PASSED
tests/api/test\_admin.py::TestAdminAPI::test\_reindex\_embeddings\_with\_parameters PASSED
tests/api/test\_admin.py::TestAdminAPI::test\_reindex\_does\_not\_require\_authentication PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_login\_success PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_login\_invalid\_credentials PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_login\_wrong\_password PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_refresh\_token\_success PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_refresh\_token\_invalid PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_refresh\_token\_wrong\_type PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_demo\_login PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_get\_me PASSED
tests/api/test\_api\_auth.py::TestAuthAPI::test\_logout PASSED
tests/api/test\_api\_entries.py::TestEntriesAPI::test\_get\_entries\_empty FAILED

\=================================== FAILURES ===================================
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPI.test\_get\_entries\_empty \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

self = \<sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt\_asyncpg\_cursor object at 0x7f439857d900>
operation = 'SELECT entries.id, entries.author\_id, entries.title, entries.content, entries.markdown\_content, entries.content\_versi...ies.is\_deleted \nFROM entries \nWHERE entries.is\_deleted = false ORDER BY entries.created\_at DESC \n LIMIT $1::INTEGER'
parameters = (20,)

```
async def _prepare_and_execute(self, operation, parameters):
    adapt_connection = self._adapt_connection

    async with adapt_connection._execute_mutex:
        if not adapt_connection._started:
            await adapt_connection._start_transaction()

        if parameters is None:
            parameters = ()

        try:
```

> ```
>           prepared_stmt, attributes = await adapt_connection._prepare(
> ```

```
                operation, self._invalidate_schema_cache_asof
```

```
            )
```

.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:521:

***

.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:768: in \_prepare
prepared\_stmt = await self.\_connection.prepare(
.venv/lib64/python3.13/site-packages/asyncpg/connection.py:635: in prepare
return await self.\_prepare(
.venv/lib64/python3.13/site-packages/asyncpg/connection.py:653: in \_prepare
stmt = await self.\_get\_statement(
.venv/lib64/python3.13/site-packages/asyncpg/connection.py:432: in \_get\_statement
statement = await self.\_protocol.prepare(

***

> ???
> E   asyncpg.exceptions.UndefinedColumnError: column entries.char\_count does not exist

asyncpg/protocol/protocol.pyx:165: UndefinedColumnError

The above exception was the direct cause of the following exception:

self = \<sqlalchemy.engine.base.Connection object at 0x7f4398580ad0>
dialect = \<sqlalchemy.dialects.postgresql.asyncpg.PGDialect\_asyncpg object at 0x7f439854eea0>
context = \<sqlalchemy.dialects.postgresql.asyncpg.PGExecutionContext\_asyncpg object at 0x7f4398566360>
statement = \<sqlalchemy.dialects.postgresql.asyncpg.PGCompiler\_asyncpg object at 0x7f43985847d0>
parameters = \[(20,)]

```
def _exec_single_context(
    self,
    dialect: Dialect,
    context: ExecutionContext,
    statement: Union[str, Compiled],
    parameters: Optional[_AnyMultiExecuteParams],
) -> CursorResult[Any]:
    """continue the _execute_context() method for a single DBAPI
    cursor.execute() or cursor.executemany() call.

    """
    if dialect.bind_typing is BindTyping.SETINPUTSIZES:
        generic_setinputsizes = context._prepare_set_input_sizes()

        if generic_setinputsizes:
            try:
                dialect.do_set_input_sizes(
                    context.cursor, generic_setinputsizes, context
                )
            except BaseException as e:
                self._handle_dbapi_exception(
                    e, str(statement), parameters, None, context
                )

    cursor, str_statement, parameters = (
        context.cursor,
        context.statement,
        context.parameters,
    )

    effective_parameters: Optional[_AnyExecuteParams]

    if not context.executemany:
        effective_parameters = parameters[0]
    else:
        effective_parameters = parameters

    if self._has_events or self.engine._has_events:
        for fn in self.dispatch.before_cursor_execute:
            str_statement, effective_parameters = fn(
                self,
                cursor,
                str_statement,
                effective_parameters,
                context,
                context.executemany,
            )

    if self._echo:
        self._log_info(str_statement)

        stats = context._get_cache_stats()

        if not self.engine.hide_parameters:
            self._log_info(
                "[%s] %r",
                stats,
                sql_util._repr_params(
                    effective_parameters,
                    batches=10,
                    ismulti=context.executemany,
                ),
            )
        else:
            self._log_info(
                "[%s] [SQL parameters hidden due to hide_parameters=True]",
                stats,
            )

    evt_handled: bool = False
    try:
        if context.execute_style is ExecuteStyle.EXECUTEMANY:
            effective_parameters = cast(
                "_CoreMultiExecuteParams", effective_parameters
            )
            if self.dialect._has_events:
                for fn in self.dialect.dispatch.do_executemany:
                    if fn(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    ):
                        evt_handled = True
                        break
            if not evt_handled:
                self.dialect.do_executemany(
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                )
        elif not effective_parameters and context.no_parameters:
            if self.dialect._has_events:
                for fn in self.dialect.dispatch.do_execute_no_params:
                    if fn(cursor, str_statement, context):
                        evt_handled = True
                        break
            if not evt_handled:
                self.dialect.do_execute_no_params(
                    cursor, str_statement, context
                )
        else:
            effective_parameters = cast(
                "_CoreSingleExecuteParams", effective_parameters
            )
            if self.dialect._has_events:
                for fn in self.dialect.dispatch.do_execute:
                    if fn(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    ):
                        evt_handled = True
                        break
            if not evt_handled:
```

> ```
>               self.dialect.do_execute(
> ```

```
                    cursor, str_statement, effective_parameters, context
```

```
                )
```

.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py:1967:

***

.venv/lib64/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do\_execute
cursor.execute(statement, parameters)
.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
self.*adapt\_connection.await*(
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:132: in await\_only
return current.parent.switch(awaitable)  # type: ignore\[no-any-return,attr-defined] # noqa: E501
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:196: in greenlet\_spawn
value = await result
^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in \_prepare\_and\_execute
self.\_handle\_exception(error)
.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in \_handle\_exception
self.\_adapt\_connection.\_handle\_exception(error)

***

self = \<AdaptedConnection \<asyncpg.connection.Connection object at 0x7f43987a16d0>>
error = UndefinedColumnError('column entries.char\_count does not exist')

```
def _handle_exception(self, error):
    if self._connection.is_closed():
        self._transaction = None
        self._started = False

    if not isinstance(error, AsyncAdapt_asyncpg_dbapi.Error):
        exception_mapping = self.dbapi._asyncpg_error_translate

        for super_ in type(error).__mro__:
            if super_ in exception_mapping:
                translated_error = exception_mapping[super_](
                    "%s: %s" % (type(error), error)
                )
                translated_error.pgcode = translated_error.sqlstate = (
                    getattr(error, "sqlstate", None)
                )
```

> ```
>               raise translated_error from error
> ```

E                   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt\_asyncpg\_dbapi.ProgrammingError: \<class 'asyncpg.exceptions.UndefinedColumnError'>: column entries.char\_count does not exist

.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:792: ProgrammingError

The above exception was the direct cause of the following exception:

self = \<test\_api\_entries.TestEntriesAPI object at 0x7f43a0200190>
client = \<httpx.AsyncClient object at 0x7f4398581a90>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.3ZSiM\_8mjUzqAitcGDFLCOVeo3r-1T02N9R0JjEvzxg'}

```
@pytest.mark.asyncio
async def test_get_entries_empty(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test getting entries when none exist."""
```

> ```
>   response = await client.get("/api/v1/entries", headers=auth_headers)
> ```

```
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
```

tests/api/test\_api\_entries.py:23:

***

.venv/lib64/python3.13/site-packages/httpx/\_client.py:1768: in get
return await self.request(
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1540: in request
return await self.send(request, auth=auth, follow\_redirects=follow\_redirects)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1629: in send
response = await self.\_send\_handling\_auth(
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1657: in \_send\_handling\_auth
response = await self.\_send\_handling\_redirects(
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1694: in \_send\_handling\_redirects
response = await self.\_send\_single\_request(request)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1730: in \_send\_single\_request
response = await transport.handle\_async\_request(request)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/httpx/\_transports/asgi.py:170: in handle\_async\_request
await self.app(scope, receive, send)
.venv/lib64/python3.13/site-packages/fastapi/applications.py:1054: in **call**
await super().**call**(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/applications.py:113: in **call**
await self.middleware\_stack(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/middleware/errors.py:186: in **call**
raise exc
.venv/lib64/python3.13/site-packages/starlette/middleware/errors.py:164: in **call**
await self.app(scope, receive, \_send)
.venv/lib64/python3.13/site-packages/starlette/middleware/cors.py:85: in **call**
await self.app(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/middleware/exceptions.py:63: in **call**
await wrap\_app\_handling\_exceptions(self.app, conn)(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/\_exception\_handler.py:53: in wrapped\_app
raise exc
.venv/lib64/python3.13/site-packages/starlette/\_exception\_handler.py:42: in wrapped\_app
await app(scope, receive, sender)
.venv/lib64/python3.13/site-packages/starlette/routing.py:716: in **call**
await self.middleware\_stack(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/routing.py:736: in app
await route.handle(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/routing.py:290: in handle
await self.app(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/routing.py:78: in app
await wrap\_app\_handling\_exceptions(app, request)(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/\_exception\_handler.py:53: in wrapped\_app
raise exc
.venv/lib64/python3.13/site-packages/starlette/\_exception\_handler.py:42: in wrapped\_app
await app(scope, receive, sender)
.venv/lib64/python3.13/site-packages/starlette/routing.py:75: in app
response = await f(request)
^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/fastapi/routing.py:302: in app
raw\_response = await run\_endpoint\_function(
.venv/lib64/python3.13/site-packages/fastapi/routing.py:213: in run\_endpoint\_function
return await dependant.call(\*\*values)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/api/v1/entries.py:139: in get\_entries
rows = await list\_entries(s, limit=limit, offset=start)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/entry\_service.py:71: in list\_entries
rows = (await s.execute(query)).scalars().all()
^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
result = await greenlet\_spawn(
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:201: in greenlet\_spawn
result = context.throw(\*sys.exc\_info())
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:2365: in execute
return self.\_execute\_internal(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:2251: in \_execute\_internal
result: Result\[Any] = compile\_state\_cls.orm\_execute\_statement(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm\_execute\_statement
result = conn.execute(
.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
return meth(
.venv/lib64/python3.13/site-packages/sqlalchemy/sql/elements.py:526: in \_execute\_on\_connection
return connection.\_execute\_clauseelement(
.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in \_execute\_clauseelement
ret = self.\_execute\_context(
.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in \_execute\_context
return self.\_exec\_single\_context(
.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in \_exec\_single\_context
self.\_handle\_dbapi\_exception(
.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py:2355: in \_handle\_dbapi\_exception
raise sqlalchemy\_exception.with\_traceback(exc\_info\[2]) from e
.venv/lib64/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in \_exec\_single\_context
self.dialect.do\_execute(
.venv/lib64/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do\_execute
cursor.execute(statement, parameters)
.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
self.*adapt\_connection.await*(
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:132: in await\_only
return current.parent.switch(awaitable)  # type: ignore\[no-any-return,attr-defined] # noqa: E501
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:196: in greenlet\_spawn
value = await result
^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in \_prepare\_and\_execute
self.\_handle\_exception(error)
.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in \_handle\_exception
self.\_adapt\_connection.\_handle\_exception(error)

***

self = \<AdaptedConnection \<asyncpg.connection.Connection object at 0x7f43987a16d0>>
error = UndefinedColumnError('column entries.char\_count does not exist')

```
def _handle_exception(self, error):
    if self._connection.is_closed():
        self._transaction = None
        self._started = False

    if not isinstance(error, AsyncAdapt_asyncpg_dbapi.Error):
        exception_mapping = self.dbapi._asyncpg_error_translate

        for super_ in type(error).__mro__:
            if super_ in exception_mapping:
                translated_error = exception_mapping[super_](
                    "%s: %s" % (type(error), error)
                )
                translated_error.pgcode = translated_error.sqlstate = (
                    getattr(error, "sqlstate", None)
                )
```

> ```
>               raise translated_error from error
> ```

E                   sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) \<class 'asyncpg.exceptions.UndefinedColumnError'>: column entries.char\_count does not exist
E                   \[SQL: SELECT entries.id, entries.author\_id, entries.title, entries.content, entries.markdown\_content, entries.content\_version, entries.created\_at, entries.updated\_at, entries.word\_count, entries.char\_count, entries.version, entries.is\_deleted
E                   FROM entries
E                   WHERE entries.is\_deleted = false ORDER BY entries.created\_at DESC
E                    LIMIT $1::INTEGER]
E                   \[parameters: (20,)]
E                   (Background on this error at: <https://sqlalche.me/e/20/f405>)

.venv/lib64/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:792: ProgrammingError
\=========================== short test summary info ============================
FAILED tests/api/test\_api\_entries.py::TestEntriesAPI::test\_get\_entries\_empty
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
\========================= 1 failed, 16 passed in 4.41s =========================
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Will assume transactional DDL.
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade  -> 0001, Enable pgvector extension and create base tables
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0001 -> 0002, Add full-text search and vector indexes
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0002 -> 0003, Add markdown dual storage columns
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0003 -> 0004\_add\_version\_lock, Add version column for optimistic locking
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0004\_add\_version\_lock -> 0005\_add\_content\_metrics, Add content metrics fields
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_add\_metrics\_safe, Online-safe add version and metrics columns
INFO  \[alembic.runtime.migration] Running upgrade 0005\_add\_content\_metrics -> 0006\_add\_metrics\_safe, Online-safe add version and metrics columns
\[alembic] Using DATABASE\_URL\_SYNC override: postgresql+psycopg2://journal:journal\@127.0.0.1:5433/journal\_test
\[alembic] Using driver: postgresql+psycopg2
\[alembic] sqlalchemy.url=postgresql+psycopg2://journal:\*\*\*@127.0.0.1:5433/journal\_test
\[alembic] driver=postgresql+psycopg2, host=127.0.0.1, database=journal\_test
\[alembic] current\_database=journal\_test
\[alembic] postgres\_version=PostgreSQL 16.10 (De...
\[alembic] application\_name=
\[migration 0001] Creating pgvector extension
\[migration 0001] Creating entries table
\[migration] Column entries.version already exists, skipping
\[migration] Column entries.word\_count already exists, skipping
\[migration] Column entries.char\_count already exists, skipping
\============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-8.4.1, pluggy-1.6.0
rootdir: /home/verlyn13/Projects/verlyn13/journal/apps/api
configfile: pyproject.toml
testpaths: tests
plugins: asyncio-1.1.0, cov-6.2.1, anyio-4.10.0, Faker-37.6.0, timeout-2.4.0
asyncio: mode=Mode.AUTO, asyncio\_default\_fixture\_loop\_scope=None, asyncio\_default\_test\_loop\_scope=function
collected 171 items

tests/api/test\_admin.py .......                                          \[  4%]
tests/api/test\_api\_auth.py .........                                     \[  9%]
tests/api/test\_api\_entries.py .E

\==================================== ERRORS ====================================
\_\_\_\_\_\_\_\_\_ ERROR at setup of TestEntriesAPI.test\_get\_entries\_with\_data \_\_\_\_\_\_\_\_\_\_

fixturedef = <FixtureDef argname='sample_entry' scope='function' baseid='tests'>
request = \<SubRequest 'sample\_entry' for <Coroutine test_get_entries_with_data>>

```
@pytest.hookimpl(wrapper=True)
def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
    asyncio_mode = _get_asyncio_mode(request.config)
    if not _is_asyncio_fixture_function(fixturedef.func):
        if asyncio_mode == Mode.STRICT:
            # Ignore async fixtures without explicit asyncio mark in strict mode
            # This applies to pytest_trio fixtures, for example
            return (yield)
        if not _is_coroutine_or_asyncgen(fixturedef.func):
            return (yield)
    default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
    loop_scope = (
        getattr(fixturedef.func, "_loop_scope", None)
        or default_loop_scope
        or fixturedef.scope
    )
    runner_fixture_id = f"_{loop_scope}_scoped_runner"
    runner = request.getfixturevalue(runner_fixture_id)
    synchronizer = _fixture_synchronizer(fixturedef, runner, request)
    _make_asyncio_fixture_function(synchronizer, loop_scope)
    with MonkeyPatch.context() as c:
        c.setattr(fixturedef, "func", synchronizer)
```

> ```
>       hook_result = yield
> ```

```
                      ^^^^^
```

.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:696:

***

.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:321: in \_async\_fixture\_wrapper
result = runner.run(setup(), context=context)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.13/asyncio/runners.py:118: in run
return self.\_loop.run\_until\_complete(task)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.13/asyncio/base\_events.py:725: in run\_until\_complete
return future.result()
^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:317: in setup
res = await fixture\_function(\*args, \*\*kwargs)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:189: in sample\_entry
await db\_session.flush()  # Flush but don't commit - let the test manage the transaction
^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:801: in flush
await greenlet\_spawn(self.sync\_session.flush, objects=objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:203: in greenlet\_spawn
result = context.switch(value)
^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4345: in flush
self.\_flush(objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4480: in \_flush
with util.safe\_reraise():
^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:224: in **exit**
raise exc\_value.with\_traceback(exc\_tb)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4441: in \_flush
flush\_context.execute()
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
rec.execute(self)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
util.preloaded.orm\_persistence.save\_obj(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:101: in save\_obj
\_finalize\_insert\_update\_commands(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:1552: in \_finalize\_insert\_update\_commands
if mapper.\_version\_id\_prop.key in state.unloaded:
^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:1338: in **get**
obj.**dict**\[self.**name**] = result = self.fget(obj)
^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:2038: in \_version\_id\_prop
return self.\_columntoproperty\[self.version\_id\_col]
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

***

self = {Column('id', Uuid(), table=<entries>, primary\_key=True, nullable=False, default=CallableColumnDefault(\<function uuid4...=<entries>, nullable=False, default=ScalarElementColumnDefault(False)): \<ColumnProperty at 0x7fc95a5dce40; is\_deleted>}
column = 'version'

```
def __missing__(self, column):
    prop = self.mapper._props.get(column)
    if prop:
        raise orm_exc.UnmappedColumnError(
            "Column '%s.%s' is not available, due to "
            "conflicting property '%s':%r"
```

> ```
>           % (column.table.name, column.name, column.key, prop)
> ```

```
               ^^^^^^^^^^^^
```

```
        )
```

E           AttributeError: 'str' object has no attribute 'table'. Did you mean: 'title'?

.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:4430: AttributeError
\=========================== short test summary info ============================
ERROR tests/api/test\_api\_entries.py::TestEntriesAPI::test\_get\_entries\_with\_data
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
\========================= 17 passed, 1 error in 3.25s ==========================
\============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-8.4.1, pluggy-1.6.0
rootdir: /home/verlyn13/Projects/verlyn13/journal/apps/api
configfile: pyproject.toml
testpaths: tests
plugins: asyncio-1.1.0, cov-6.2.1, anyio-4.10.0, Faker-37.6.0, timeout-2.4.0, xdist-3.8.0
asyncio: mode=Mode.AUTO, asyncio\_default\_fixture\_loop\_scope=None, asyncio\_default\_test\_loop\_scope=function
created: 12/12 workers
12 workers \[171 items]

...F.....F...............EEEF
\==================================== ERRORS ====================================
\_\_\_\_\_\_\_\_\_\_ ERROR at setup of TestEntriesAPI.test\_update\_entry\_success \_\_\_\_\_\_\_\_\_\_
\[gw5] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

fixturedef = <FixtureDef argname='sample_entry' scope='function' baseid='tests'>
request = \<SubRequest 'sample\_entry' for <Coroutine test_update_entry_success>>

```
@pytest.hookimpl(wrapper=True)
def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
    asyncio_mode = _get_asyncio_mode(request.config)
    if not _is_asyncio_fixture_function(fixturedef.func):
        if asyncio_mode == Mode.STRICT:
            # Ignore async fixtures without explicit asyncio mark in strict mode
            # This applies to pytest_trio fixtures, for example
            return (yield)
        if not _is_coroutine_or_asyncgen(fixturedef.func):
            return (yield)
    default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
    loop_scope = (
        getattr(fixturedef.func, "_loop_scope", None)
        or default_loop_scope
        or fixturedef.scope
    )
    runner_fixture_id = f"_{loop_scope}_scoped_runner"
    runner = request.getfixturevalue(runner_fixture_id)
    synchronizer = _fixture_synchronizer(fixturedef, runner, request)
    _make_asyncio_fixture_function(synchronizer, loop_scope)
    with MonkeyPatch.context() as c:
        c.setattr(fixturedef, "func", synchronizer)
```

> ```
>       hook_result = yield
> ```

```
                      ^^^^^
```

.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:696:

***

.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:321: in \_async\_fixture\_wrapper
result = runner.run(setup(), context=context)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.13/asyncio/runners.py:118: in run
return self.\_loop.run\_until\_complete(task)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.13/asyncio/base\_events.py:725: in run\_until\_complete
return future.result()
^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:317: in setup
res = await fixture\_function(\*args, \*\*kwargs)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:189: in sample\_entry
await db\_session.flush()  # Flush but don't commit - let the test manage the transaction
^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:801: in flush
await greenlet\_spawn(self.sync\_session.flush, objects=objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:203: in greenlet\_spawn
result = context.switch(value)
^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4345: in flush
self.\_flush(objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4480: in \_flush
with util.safe\_reraise():
^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:224: in **exit**
raise exc\_value.with\_traceback(exc\_tb)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4441: in \_flush
flush\_context.execute()
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
rec.execute(self)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
util.preloaded.orm\_persistence.save\_obj(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:101: in save\_obj
\_finalize\_insert\_update\_commands(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:1552: in \_finalize\_insert\_update\_commands
if mapper.\_version\_id\_prop.key in state.unloaded:
^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:1338: in **get**
obj.**dict**\[self.**name**] = result = self.fget(obj)
^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:2038: in \_version\_id\_prop
return self.\_columntoproperty\[self.version\_id\_col]
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

***

self = {Column('id', Uuid(), table=<entries>, primary\_key=True, nullable=False, default=CallableColumnDefault(\<function uuid4...=<entries>, nullable=False, default=ScalarElementColumnDefault(False)): \<ColumnProperty at 0x7f84a2e80f40; is\_deleted>}
column = 'version'

```
def __missing__(self, column):
    prop = self.mapper._props.get(column)
    if prop:
        raise orm_exc.UnmappedColumnError(
            "Column '%s.%s' is not available, due to "
            "conflicting property '%s':%r"
```

> ```
>           % (column.table.name, column.name, column.key, prop)
> ```

```
               ^^^^^^^^^^^^
```

```
        )
```

E           AttributeError: 'str' object has no attribute 'table'. Did you mean: 'title'?

.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:4430: AttributeError
\_\_\_\_\_\_\_\_\_ ERROR at setup of TestEntriesAPI.test\_get\_entries\_with\_data \_\_\_\_\_\_\_\_\_\_
\[gw9] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

fixturedef = <FixtureDef argname='sample_entry' scope='function' baseid='tests'>
request = \<SubRequest 'sample\_entry' for <Coroutine test_get_entries_with_data>>

```
@pytest.hookimpl(wrapper=True)
def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
    asyncio_mode = _get_asyncio_mode(request.config)
    if not _is_asyncio_fixture_function(fixturedef.func):
        if asyncio_mode == Mode.STRICT:
            # Ignore async fixtures without explicit asyncio mark in strict mode
            # This applies to pytest_trio fixtures, for example
            return (yield)
        if not _is_coroutine_or_asyncgen(fixturedef.func):
            return (yield)
    default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
    loop_scope = (
        getattr(fixturedef.func, "_loop_scope", None)
        or default_loop_scope
        or fixturedef.scope
    )
    runner_fixture_id = f"_{loop_scope}_scoped_runner"
    runner = request.getfixturevalue(runner_fixture_id)
    synchronizer = _fixture_synchronizer(fixturedef, runner, request)
    _make_asyncio_fixture_function(synchronizer, loop_scope)
    with MonkeyPatch.context() as c:
        c.setattr(fixturedef, "func", synchronizer)
```

> ```
>       hook_result = yield
> ```

```
                      ^^^^^
```

.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:696:

***

.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:321: in \_async\_fixture\_wrapper
result = runner.run(setup(), context=context)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.13/asyncio/runners.py:118: in run
return self.\_loop.run\_until\_complete(task)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.13/asyncio/base\_events.py:725: in run\_until\_complete
return future.result()
^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:317: in setup
res = await fixture\_function(\*args, \*\*kwargs)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:189: in sample\_entry
await db\_session.flush()  # Flush but don't commit - let the test manage the transaction
^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:801: in flush
await greenlet\_spawn(self.sync\_session.flush, objects=objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:203: in greenlet\_spawn
result = context.switch(value)
^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4345: in flush
self.\_flush(objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4480: in \_flush
with util.safe\_reraise():
^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:224: in **exit**
raise exc\_value.with\_traceback(exc\_tb)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4441: in \_flush
flush\_context.execute()
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
rec.execute(self)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
util.preloaded.orm\_persistence.save\_obj(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:101: in save\_obj
\_finalize\_insert\_update\_commands(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:1552: in \_finalize\_insert\_update\_commands
if mapper.\_version\_id\_prop.key in state.unloaded:
^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:1338: in **get**
obj.**dict**\[self.**name**] = result = self.fget(obj)
^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:2038: in \_version\_id\_prop
return self.\_columntoproperty\[self.version\_id\_col]
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

***

self = {Column('id', Uuid(), table=<entries>, primary\_key=True, nullable=False, default=CallableColumnDefault(\<function uuid4...=<entries>, nullable=False, default=ScalarElementColumnDefault(False)): \<ColumnProperty at 0x7fd7ed868f40; is\_deleted>}
column = 'version'

```
def __missing__(self, column):
    prop = self.mapper._props.get(column)
    if prop:
        raise orm_exc.UnmappedColumnError(
            "Column '%s.%s' is not available, due to "
            "conflicting property '%s':%r"
```

> ```
>           % (column.table.name, column.name, column.key, prop)
> ```

```
               ^^^^^^^^^^^^
```

```
        )
```

E           AttributeError: 'str' object has no attribute 'table'. Did you mean: 'title'?

.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:4430: AttributeError
\_\_\_\_\_\_\_ ERROR at setup of TestEntriesDeleteAPI.test\_delete\_entry\_success \_\_\_\_\_\_\_
\[gw6] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

fixturedef = <FixtureDef argname='sample_entry' scope='function' baseid='tests'>
request = \<SubRequest 'sample\_entry' for <Coroutine test_delete_entry_success>>

```
@pytest.hookimpl(wrapper=True)
def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
    asyncio_mode = _get_asyncio_mode(request.config)
    if not _is_asyncio_fixture_function(fixturedef.func):
        if asyncio_mode == Mode.STRICT:
            # Ignore async fixtures without explicit asyncio mark in strict mode
            # This applies to pytest_trio fixtures, for example
            return (yield)
        if not _is_coroutine_or_asyncgen(fixturedef.func):
            return (yield)
    default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
    loop_scope = (
        getattr(fixturedef.func, "_loop_scope", None)
        or default_loop_scope
        or fixturedef.scope
    )
    runner_fixture_id = f"_{loop_scope}_scoped_runner"
    runner = request.getfixturevalue(runner_fixture_id)
    synchronizer = _fixture_synchronizer(fixturedef, runner, request)
    _make_asyncio_fixture_function(synchronizer, loop_scope)
    with MonkeyPatch.context() as c:
        c.setattr(fixturedef, "func", synchronizer)
```

> ```
>       hook_result = yield
> ```

```
                      ^^^^^
```

.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:696:

***

.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:321: in \_async\_fixture\_wrapper
result = runner.run(setup(), context=context)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.13/asyncio/runners.py:118: in run
return self.\_loop.run\_until\_complete(task)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.13/asyncio/base\_events.py:725: in run\_until\_complete
return future.result()
^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/pytest\_asyncio/plugin.py:317: in setup
res = await fixture\_function(\*args, \*\*kwargs)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:189: in sample\_entry
await db\_session.flush()  # Flush but don't commit - let the test manage the transaction
^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:801: in flush
await greenlet\_spawn(self.sync\_session.flush, objects=objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:203: in greenlet\_spawn
result = context.switch(value)
^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4345: in flush
self.\_flush(objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4480: in \_flush
with util.safe\_reraise():
^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:224: in **exit**
raise exc\_value.with\_traceback(exc\_tb)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4441: in \_flush
flush\_context.execute()
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
rec.execute(self)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
util.preloaded.orm\_persistence.save\_obj(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:101: in save\_obj
\_finalize\_insert\_update\_commands(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:1552: in \_finalize\_insert\_update\_commands
if mapper.\_version\_id\_prop.key in state.unloaded:
^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:1338: in **get**
obj.**dict**\[self.**name**] = result = self.fget(obj)
^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:2038: in \_version\_id\_prop
return self.\_columntoproperty\[self.version\_id\_col]
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

***

self = {Column('id', Uuid(), table=<entries>, primary\_key=True, nullable=False, default=CallableColumnDefault(\<function uuid4...=<entries>, nullable=False, default=ScalarElementColumnDefault(False)): \<ColumnProperty at 0x7fc556e70f40; is\_deleted>}
column = 'version'

```
def __missing__(self, column):
    prop = self.mapper._props.get(column)
    if prop:
        raise orm_exc.UnmappedColumnError(
            "Column '%s.%s' is not available, due to "
            "conflicting property '%s':%r"
```

> ```
>           % (column.table.name, column.name, column.key, prop)
> ```

```
               ^^^^^^^^^^^^
```

```
        )
```

E           AttributeError: 'str' object has no attribute 'table'. Did you mean: 'title'?

.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:4430: AttributeError
\=================================== FAILURES ===================================
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPI.test\_update\_entry\_not\_found \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw10] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries.TestEntriesAPI object at 0x7fad84132450>
client = \<httpx.AsyncClient object at 0x7fad6c459010>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.bOAHrRKxSkzLQOdLcS8\_UUiKZa2MWLDi2zBt\_ZLOB\_g'}

```
@pytest.mark.asyncio
async def test_update_entry_not_found(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test updating a non-existent entry."""
    non_existent_id = "550e8400-e29b-41d4-a716-446655440999"
    update_data = {"title": "Won't work"}

    response = await client.put(
        f"/api/v1/entries/{non_existent_id}",
        json=update_data,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 404
> ```

E       assert 422 == 404
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries.py:171: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_not\_found \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw8] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7faa6c394910>
client = \<httpx.AsyncClient object at 0x7faa5c63d010>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.bOAHrRKxSkzLQOdLcS8\_UUiKZa2MWLDi2zBt\_ZLOB\_g'}

```
@pytest.mark.asyncio
async def test_delete_entry_not_found(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test deleting non-existent entry."""
    fake_id = str(uuid4())
    response = await client.delete(
        f"/api/v1/entries/{fake_id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 404
> ```

E       assert 422 == 404
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:53: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPI.test\_create\_entry\_success \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw11] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries.TestEntriesAPI object at 0x7f03ec3448a0>
client = \<httpx.AsyncClient object at 0x7f03e4659010>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.bOAHrRKxSkzLQOdLcS8\_UUiKZa2MWLDi2zBt\_ZLOB\_g'}

```
@pytest.mark.asyncio
async def test_create_entry_success(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test successful entry creation."""
    entry_data = create_test_entry_data("New Entry", "Some content here")
```

> ```
>   response = await client.post(
> ```

```
        "/api/v1/entries",
```

```
        json=entry_data,
        headers=auth_headers
    )
```

tests/api/test\_api\_entries.py:51:

***

.venv/lib64/python3.13/site-packages/httpx/\_client.py:1859: in post
return await self.request(
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1540: in request
return await self.send(request, auth=auth, follow\_redirects=follow\_redirects)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1629: in send
response = await self.\_send\_handling\_auth(
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1657: in \_send\_handling\_auth
response = await self.\_send\_handling\_redirects(
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1694: in \_send\_handling\_redirects
response = await self.\_send\_single\_request(request)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/httpx/\_client.py:1730: in \_send\_single\_request
response = await transport.handle\_async\_request(request)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/httpx/\_transports/asgi.py:170: in handle\_async\_request
await self.app(scope, receive, send)
.venv/lib64/python3.13/site-packages/fastapi/applications.py:1054: in **call**
await super().**call**(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/applications.py:113: in **call**
await self.middleware\_stack(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/middleware/errors.py:186: in **call**
raise exc
.venv/lib64/python3.13/site-packages/starlette/middleware/errors.py:164: in **call**
await self.app(scope, receive, \_send)
.venv/lib64/python3.13/site-packages/starlette/middleware/cors.py:85: in **call**
await self.app(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/middleware/exceptions.py:63: in **call**
await wrap\_app\_handling\_exceptions(self.app, conn)(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/\_exception\_handler.py:53: in wrapped\_app
raise exc
.venv/lib64/python3.13/site-packages/starlette/\_exception\_handler.py:42: in wrapped\_app
await app(scope, receive, sender)
.venv/lib64/python3.13/site-packages/starlette/routing.py:716: in **call**
await self.middleware\_stack(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/routing.py:736: in app
await route.handle(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/routing.py:290: in handle
await self.app(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/routing.py:78: in app
await wrap\_app\_handling\_exceptions(app, request)(scope, receive, send)
.venv/lib64/python3.13/site-packages/starlette/\_exception\_handler.py:53: in wrapped\_app
raise exc
.venv/lib64/python3.13/site-packages/starlette/\_exception\_handler.py:42: in wrapped\_app
await app(scope, receive, sender)
.venv/lib64/python3.13/site-packages/starlette/routing.py:75: in app
response = await f(request)
^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/fastapi/routing.py:302: in app
raw\_response = await run\_endpoint\_function(
.venv/lib64/python3.13/site-packages/fastapi/routing.py:213: in run\_endpoint\_function
return await dependant.call(\*\*values)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/api/v1/entries.py:176: in post\_entry
entry = await repo.create(entry\_data)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/infra/repository.py:49: in create
await self.session.flush()
.venv/lib64/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:801: in flush
await greenlet\_spawn(self.sync\_session.flush, objects=objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/util/\_concurrency\_py3k.py:203: in greenlet\_spawn
result = context.switch(value)
^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4345: in flush
self.\_flush(objects)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4480: in \_flush
with util.safe\_reraise():
^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:224: in **exit**
raise exc\_value.with\_traceback(exc\_tb)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/session.py:4441: in \_flush
flush\_context.execute()
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
rec.execute(self)
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
util.preloaded.orm\_persistence.save\_obj(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:101: in save\_obj
\_finalize\_insert\_update\_commands(
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/persistence.py:1552: in \_finalize\_insert\_update\_commands
if mapper.\_version\_id\_prop.key in state.unloaded:
^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/util/langhelpers.py:1338: in **get**
obj.**dict**\[self.**name**] = result = self.fget(obj)
^^^^^^^^^^^^^^
.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:2038: in \_version\_id\_prop
return self.\_columntoproperty\[self.version\_id\_col]
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

***

self = {Column('id', Uuid(), table=<entries>, primary\_key=True, nullable=False, default=CallableColumnDefault(\<function uuid4...=<entries>, nullable=False, default=ScalarElementColumnDefault(False)): \<ColumnProperty at 0x7f03f0478f40; is\_deleted>}
column = 'version'

```
def __missing__(self, column):
    prop = self.mapper._props.get(column)
    if prop:
        raise orm_exc.UnmappedColumnError(
            "Column '%s.%s' is not available, due to "
            "conflicting property '%s':%r"
```

> ```
>           % (column.table.name, column.name, column.key, prop)
> ```

```
               ^^^^^^^^^^^^
```

```
        )
```

E           AttributeError: 'str' object has no attribute 'table'. Did you mean: 'title'?

.venv/lib64/python3.13/site-packages/sqlalchemy/orm/mapper.py:4430: AttributeError
\=========================== short test summary info ============================
ERROR tests/api/test\_api\_entries.py::TestEntriesAPI::test\_update\_entry\_success
ERROR tests/api/test\_api\_entries.py::TestEntriesAPI::test\_get\_entries\_with\_data
ERROR tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_success
FAILED tests/api/test\_api\_entries.py::TestEntriesAPI::test\_update\_entry\_not\_found
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_not\_found
FAILED tests/api/test\_api\_entries.py::TestEntriesAPI::test\_create\_entry\_success
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 6 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!! xdist.dsession.Interrupted: stopping after 1 failures !!!!!!!!!!!!!
\=================== 3 failed, 23 passed, 3 errors in 17.27s ====================
\============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-8.4.1, pluggy-1.6.0
rootdir: /home/verlyn13/Projects/verlyn13/journal/apps/api
configfile: pyproject.toml
testpaths: tests
plugins: asyncio-1.1.0, cov-6.2.1, anyio-4.10.0, Faker-37.6.0, timeout-2.4.0, xdist-3.8.0
asyncio: mode=Mode.AUTO, asyncio\_default\_fixture\_loop\_scope=None, asyncio\_default\_test\_loop\_scope=function
created: 12/12 workers
12 workers \[171 items]

........FF..............F.....F
\=================================== FAILURES ===================================
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_not\_found \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw9] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7f00f46a0910>
client = \<httpx.AsyncClient object at 0x7f00f4258ec0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.BERg5gwd9ha8hp4OQQiKf22GpDnSCEylhtKsAMjf2L4'}

```
@pytest.mark.asyncio
async def test_delete_entry_not_found(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test deleting non-existent entry."""
    fake_id = str(uuid4())
    response = await client.delete(
        f"/api/v1/entries/{fake_id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 404
> ```

E       assert 422 == 404
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:53: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPI.test\_update\_entry\_not\_found \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw4] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries.TestEntriesAPI object at 0x7f0dc030e450>
client = \<httpx.AsyncClient object at 0x7f0db8638ec0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.BERg5gwd9ha8hp4OQQiKf22GpDnSCEylhtKsAMjf2L4'}

```
@pytest.mark.asyncio
async def test_update_entry_not_found(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test updating a non-existent entry."""
    non_existent_id = "550e8400-e29b-41d4-a716-446655440999"
    update_data = {"title": "Won't work"}

    response = await client.put(
        f"/api/v1/entries/{non_existent_id}",
        json=update_data,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 404
> ```

E       assert 422 == 404
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries.py:171: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPI.test\_update\_entry\_success \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw6] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries.TestEntriesAPI object at 0x7fa99477cf30>
client = \<httpx.AsyncClient object at 0x7fa9946f4a50>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.4YR8FRZ1JxCQEnUe2ei5F5bdEKE-T9eNKANz6a1SJWQ'}
sample\_entry = Entry(id='ee982033-0b94-406e-9eca-056fb1085d78', author\_id='f7e3ce49-18ae-4257-bb79-65f10ca5eb21', title='Test Entry',..., 3, 4, 8, 16940), updated\_at=datetime.datetime(2025, 9, 3, 3, 4, 8, 16958), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_success(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test successful entry update."""
    update_data = {
        "title": "Updated Title",
        "content": "Updated content"
    }

    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update_data,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries.py:129: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_success \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw10] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7fd21c19c7d0>
client = \<httpx.AsyncClient object at 0x7fd20c448e10>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.4YR8FRZ1JxCQEnUe2ei5F5bdEKE-T9eNKANz6a1SJWQ'}
sample\_entry = Entry(id='357d69b6-ee3d-4eff-b7b7-6cbffc40d454', author\_id='cf067628-ee95-43cf-ae67-440f9a20ae99', title='Test Entry',...3, 4, 8, 343641), updated\_at=datetime.datetime(2025, 9, 3, 3, 4, 8, 343679), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_delete_entry_success(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test successful entry deletion."""
    response = await client.delete(
        f"/api/v1/entries/{sample_entry.id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 204
> ```

E       assert 422 == 204
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:30: AssertionError
\=========================== short test summary info ============================
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_not\_found
FAILED tests/api/test\_api\_entries.py::TestEntriesAPI::test\_update\_entry\_not\_found
FAILED tests/api/test\_api\_entries.py::TestEntriesAPI::test\_update\_entry\_success
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_success
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 4 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!! xdist.dsession.Interrupted: stopping after 1 failures !!!!!!!!!!!!!
\======================== 4 failed, 27 passed in 15.23s =========================
\============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-8.4.1, pluggy-1.6.0
rootdir: /home/verlyn13/Projects/verlyn13/journal/apps/api
configfile: pyproject.toml
testpaths: tests
plugins: asyncio-1.1.0, cov-6.2.1, anyio-4.10.0, Faker-37.6.0, timeout-2.4.0, xdist-3.8.0
asyncio: mode=Mode.AUTO, asyncio\_default\_fixture\_loop\_scope=None, asyncio\_default\_test\_loop\_scope=function
created: 12/12 workers
12 workers \[171 items]

......................F....F...F..F.FFFFF.F.F.FF.FFFFF.F..F.FF.F.FFFF.F. \[ 42%]
FFFF
\=================================== FAILURES ===================================
\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_invalid\_uuid \_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw7] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7f6a1837d220>
client = \<httpx.AsyncClient object at 0x7f6a182e8a50>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}

```
@pytest.mark.asyncio
async def test_delete_entry_invalid_uuid(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test deleting entry with invalid UUID."""
    response = await client.delete(
        "/api/v1/entries/not-a-valid-uuid",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 404
> ```

E       assert 422 == 404
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:68: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPI.test\_delete\_entry\_success \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw8] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries.TestEntriesAPI object at 0x7fde8014cb90>
client = \<httpx.AsyncClient object at 0x7fde787eca50>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='24572b47-7549-4c72-bf6e-c08d2cb609a7', author\_id='82af77f9-a386-4330-a310-71033a2012d0', title='Test Entry',... 6, 50, 148839), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 148862), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_delete_entry_success(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test successful entry deletion."""
    response = await client.delete(
        f"/api/v1/entries/{sample_entry.id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 204
> ```

E       assert 422 == 204
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries.py:187: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_success \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw6] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7ff0187887d0>
client = \<httpx.AsyncClient object at 0x7ff018334e10>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='d855edf1-25e5-4c3f-9511-1e29627f8dd4', author\_id='312c39e1-d05d-47f4-a69e-035ed54f50c7', title='Test Entry',... 6, 50, 209535), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 209557), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_delete_entry_success(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test successful entry deletion."""
    response = await client.delete(
        f"/api/v1/entries/{sample_entry.id}?expected_version={sample_entry.version}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 204
> ```

E       assert 200 == 204
E        +  where 200 = \<Response \[200 OK]>.status\_code

tests/api/test\_api\_entries\_delete.py:30: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_soft\_delete \_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw7] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7f6a1837d350>
client = \<httpx.AsyncClient object at 0x7f6a084da990>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='ef53aaa1-e67d-4a6b-8803-b1a6af61618c', author\_id='66f477ad-60c3-4d74-a8b3-4ae6e76957fb', title='Test Entry',... 6, 50, 363776), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 363800), char\_count=0, version=1, is\_deleted=False)
db\_session = \<sqlalchemy.orm.session.AsyncSession object at 0x7f6a0853c2d0>

```
@pytest.mark.asyncio
async def test_delete_entry_soft_delete(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry,
    db_session: AsyncSession
):
    """Test that deletion is soft delete (is_deleted flag)."""
    entry_id = str(sample_entry.id)

    # Delete the entry
    response = await client.delete(
        f"/api/v1/entries/{entry_id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 204
> ```

E       assert 422 == 204
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:87: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_with\_embedding \_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw9] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7f590c1c55b0>
client = \<httpx.AsyncClient object at 0x7f59043fa780>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
db\_session = \<sqlalchemy.orm.session.AsyncSession object at 0x7f59045fc190>

```
@pytest.mark.asyncio
async def test_delete_entry_with_embedding(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    db_session: AsyncSession
):
    """Test deleting entry that has an embedding."""
    # Create entry
    entry = Entry(
        title="Entry with embedding",
        content="Content to embed",
        author_id="11111111-1111-1111-1111-111111111111"
    )
    db_session.add(entry)
    await db_session.commit()

    # Add embedding
    embedding = [0.1] * 1536
    embedding_str = "[" + ",".join(str(x) for x in embedding) + "]"
    await db_session.execute(
        text(f"""
            INSERT INTO entry_embeddings(entry_id, embedding)
            VALUES (:id, '{embedding_str}'::vector)
        """),
        {"id": str(entry.id)}
    )
    await db_session.commit()

    # Delete the entry
    response = await client.delete(
        f"/api/v1/entries/{entry.id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 204
> ```

E       assert 422 == 204
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:132: AssertionError
\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_updates\_is\_deleted\_flag \_\_\_\_\_\_\_\_
\[gw10] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7f577062aa50>
client = \<httpx.AsyncClient object at 0x7f57701fe780>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='2007a5d5-633c-49e0-89bd-4c77eb894b4e', author\_id='1e55d2d3-ae7e-490d-8ff3-dcad101fb887', title='Test Entry',... 6, 50, 380759), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 380782), char\_count=0, version=1, is\_deleted=False)
db\_session = \<sqlalchemy.orm.session.AsyncSession object at 0x7f5770400190>

```
@pytest.mark.asyncio
async def test_delete_entry_updates_is_deleted_flag(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry,
    db_session: AsyncSession
):
    """Test that deletion sets is_deleted flag and updates timestamp."""
    entry_id = str(sample_entry.id)

    # Check initial state
    result = await db_session.execute(
        text("SELECT is_deleted, updated_at FROM entries WHERE id = :id"),
        {"id": entry_id}
    )
    row = result.first()
    assert row[0] is False  # is_deleted should be False initially
    initial_updated_at = row[1]

    # Delete the entry
    response = await client.delete(
        f"/api/v1/entries/{entry_id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 204
> ```

E       assert 422 == 204
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:225: AssertionError
\_\_\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_html\_preserves\_version \_\_\_\_\_\_\_\_
\[gw11] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7fd3b0495810>
client = \<httpx.AsyncClient object at 0x7fd398649350>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='daf0cd96-9711-474f-9b48-49d18e43aa22', author\_id='d59c306b-ae62-4b18-a967-ef5762564a07', title='Test Entry',... 6, 50, 395385), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 395411), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_html_preserves_version(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test that updating HTML content preserves existing version."""
    # First set to markdown version
    update1 = {
        "markdown_content": "# Title",
        "content_version": 2
    }
    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update1,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:89: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPI.test\_delete\_entry\_not\_found \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw8] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries.TestEntriesAPI object at 0x7fde8014cd70>
client = \<httpx.AsyncClient object at 0x7fde78313ed0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}

```
@pytest.mark.asyncio
async def test_delete_entry_not_found(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test deleting a non-existent entry."""
    non_existent_id = "550e8400-e29b-41d4-a716-446655440999"
    response = await client.delete(
        f"/api/v1/entries/{non_existent_id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 404
> ```

E       assert 422 == 404
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries.py:209: AssertionError
\_\_\_\_\_\_\_\_\_\_ TestEntriesAPIErrors.test\_update\_entry\_markdown\_conversion \_\_\_\_\_\_\_\_\_\_
\[gw3] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_errors.TestEntriesAPIErrors object at 0x7f706028d480>
client = \<httpx.AsyncClient object at 0x7f70484150f0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='8b22f655-94dd-4419-b901-57e72438210c', author\_id='eacd7b8a-036d-4d18-bb66-7073620d5088', title='Test Entry',... 6, 50, 442931), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 442953), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_markdown_conversion(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test updating entry with markdown content."""
    update_data = {
        "markdown_content": "# Heading\n\nSome **bold** text"
    }

    # Add header to indicate markdown preference
    headers = {**auth_headers, "X-Editor-Mode": "markdown"}

    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update_data,
        headers=headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_errors.py:92: AssertionError
\_\_\_\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_markdown\_with\_images \_\_\_\_\_\_\_\_\_
\[gw2] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7f7af05957b0>
client = \<httpx.AsyncClient object at 0x7f7ae0752650>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='b4ed8e54-aca9-4a86-bab1-b7e03a983b6b', author\_id='5b3c0f22-b49a-4b48-9a9b-0f39078a8e08', title='Test Entry',... 6, 50, 517336), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 517352), char\_count=0, version=1, is\_deleted=False)

```
    @pytest.mark.asyncio
    async def test_update_entry_markdown_with_images(
        self,
        client: AsyncClient,
        auth_headers: dict[str, str],
        sample_entry: Entry
    ):
        """Test markdown with images converts properly."""
        update_data = {
            "markdown_content": """# Article with Images

![Alt text](https://example.com/image.jpg)

Some text here.

![Another image](https://example.com/photo.png "With title")
"""
        }

        response = await client.put(
            f"/api/v1/entries/{sample_entry.id}",
            json=update_data,
            headers=auth_headers
        )
```

> ```
>       assert response.status_code == 200
> ```

E           assert 422 == 200
E            +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:210: AssertionError
\_\_\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_prefer\_markdown\_header \_\_\_\_\_\_\_\_
\[gw0] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7f1fd8227350>
client = \<httpx.AsyncClient object at 0x7f1fc84fb5c0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='f0b97c92-0cb5-44c6-b883-1a0fd48f3139', author\_id='5cab55ec-c6a5-415b-a38f-e783333e09c3', title='Test Entry',... 6, 50, 586755), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 586774), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_prefer_markdown_header(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test X-Editor-Mode header for markdown preference."""
    # Update with markdown
    update_data = {
        "markdown_content": "# Markdown Title\n\nContent here."
    }

    # With markdown preference header
    headers = {**auth_headers, "X-Editor-Mode": "markdown"}

    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update_data,
        headers=headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:294: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_idempotent \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw9] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7f590c181370>
client = \<httpx.AsyncClient object at 0x7f59042cd940>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='1ad11128-8114-4acd-b0ab-8f6b59fc6e3f', author\_id='37ed80b0-a67d-47de-b275-f7816fcf30b4', title='Test Entry',... 6, 50, 682498), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 682512), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_delete_entry_idempotent(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test that deletion is idempotent."""
    entry_id = str(sample_entry.id)

    # First deletion
    response = await client.delete(
        f"/api/v1/entries/{entry_id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 204
> ```

E       assert 422 == 204
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:152: AssertionError
\_ TestEntriesQuality.test\_update\_entry\_preserves\_data\_integrity\_with\_partial\_updates \_
\[gw7] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_entries\_quality.TestEntriesQuality object at 0x7f6a183956d0>
client = \<httpx.AsyncClient object at 0x7f6a0850a9e0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='7f3caf86-938b-42eb-8c2e-0e68c25a7ff7', author\_id='5d08c7fb-3b9d-41b2-9086-4d8394c11656', title='Test Entry',... 6, 50, 670227), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 670243), char\_count=0, version=1, is\_deleted=False)
db\_session = \<sqlalchemy.orm.session.AsyncSession object at 0x7f6a0853dd10>

```
@pytest.mark.asyncio
async def test_update_entry_preserves_data_integrity_with_partial_updates(
    self, client: AsyncClient, auth_headers: dict[str, str],
    sample_entry: Entry, db_session: AsyncSession
):
    """Test that partial updates don't corrupt existing data."""
    # Start with a complete entry
    entry_id = str(sample_entry.id)
    original_response = await client.get(
        f"/api/v1/entries/{entry_id}",
        headers=auth_headers
    )
    original_data = original_response.json()

    # Update only the title
    update_response = await client.put(
        f"/api/v1/entries/{entry_id}",
        json={"title": "Updated Title Only"},
        headers=auth_headers
    )
```

> ```
>   assert update_response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_entries\_quality.py:37: AssertionError
\_\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_markdown\_with\_code\_blocks \_\_\_\_\_\_
\[gw11] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7fd3b0495940>
client = \<httpx.AsyncClient object at 0x7fd39864b820>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='e864b7c6-1fe3-46cb-9b2a-9877fd1e643f', author\_id='8e50db00-cdfc-4fa7-9e53-41a4646a8cc8', title='Test Entry',... 6, 50, 761693), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 761715), char\_count=0, version=1, is\_deleted=False)

````
    @pytest.mark.asyncio
    async def test_update_entry_markdown_with_code_blocks(
        self,
        client: AsyncClient,
        auth_headers: dict[str, str],
        sample_entry: Entry
    ):
        """Test markdown with code blocks converts properly."""
        update_data = {
            "markdown_content": """# Code Example

Here's some Python:

```python
def hello():
    print("Hello, World!")
```

And some JavaScript:

```javascript
console.log("Hello");
```
"""
        }

        response = await client.put(
            f"/api/v1/entries/{sample_entry.id}",
            json=update_data,
            headers=auth_headers
        )
````

> ```
>       assert response.status_code == 200
> ```

E           assert 422 == 200
E            +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:139: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesQuality.test\_content\_length\_tracking \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw5] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_entries\_quality.TestEntriesQuality object at 0x7fd448182190>
client = \<httpx.AsyncClient object at 0x7fd44030f230>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}

```
@pytest.mark.asyncio
async def test_content_length_tracking(
    self, client: AsyncClient, auth_headers: dict[str, str]
):
    """Test that content length is tracked appropriately."""
    test_cases = [
        {
            "content": "<p>This is a simple test.</p>",
            "min_length": 10
        },
        {
            "markdown_content": "# Title\n\nThis is **bold** and _italic_ text.",
            "min_length": 20
        },
        {
            "content": "<h1>Title</h1><p>Paragraph with <strong>formatting</strong></p>",
            "min_length": 15
        }
    ]

    for case in test_cases:
        response = await client.post(
            "/api/v1/entries",
            json={"title": "Content Test", **case},
            headers=auth_headers
        )
        assert response.status_code == 201
        data = response.json()

        # Verify content is present and has expected minimum length
        assert "content" in data
```

> ```
>       assert len(data["content"]) >= case["min_length"]
> ```

E           AssertionError: assert 0 >= 20
E            +  where 0 = len('')

tests/api/test\_entries\_quality.py:166: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_deleted\_entry\_not\_in\_list \_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw10] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7f5770659130>
client = \<httpx.AsyncClient object at 0x7f57700d7e10>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='d657e3e6-8ba8-44f3-b1a6-ed4f19c24b8c', author\_id='cfb868e2-4568-4624-b45f-4d20dca4105a', title='Test Entry',... 6, 50, 764589), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 764606), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_deleted_entry_not_in_list(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test that deleted entries don't appear in list."""
    # Get initial list
    response = await client.get(
        "/api/v1/entries",
        headers=auth_headers
    )
    assert response.status_code == 200
    initial_count = len(response.json())

    # Delete an entry
    response = await client.delete(
        f"/api/v1/entries/{sample_entry.id}",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 204
> ```

E       assert 422 == 204
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:258: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPIErrors.test\_update\_entry\_html\_conversion \_\_\_\_\_\_\_\_\_\_\_\_
\[gw3] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_errors.TestEntriesAPIErrors object at 0x7f706028d5b0>
client = \<httpx.AsyncClient object at 0x7f70484155b0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='b46b6c92-db41-429d-9ca0-556d6a9c89dc', author\_id='a5b4c2c4-e0ae-47ce-8aae-8c1493101ac1', title='Test Entry',... 6, 50, 811735), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 811750), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_html_conversion(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test updating entry with HTML content."""
    update_data = {
        "content": "<h1>Title</h1><p>Paragraph</p>"
    }

    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update_data,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_errors.py:117: AssertionError
\_\_\_\_\_\_\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_empty\_markdown \_\_\_\_\_\_\_\_\_\_\_\_
\[gw2] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7f7af05958c0>
client = \<httpx.AsyncClient object at 0x7f7af00ae3f0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='803a4a3a-f7f7-41be-bb6f-4f7275a1f642', author\_id='aa70de7b-a5cd-4ea0-821a-a82e48f69ef7', title='Test Entry',... 6, 50, 810198), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 810214), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_empty_markdown(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test updating with empty markdown content."""
    update_data = {
        "markdown_content": ""
    }

    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update_data,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:235: AssertionError
\_\_\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_mixed\_content\_priority \_\_\_\_\_\_\_\_
\[gw0] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7f1fd82556d0>
client = \<httpx.AsyncClient object at 0x7f1fc83d0640>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='c73189dd-6272-4169-b8e2-77d0266448f0', author\_id='8b712cb2-4f0f-4270-b6c5-bfe58a19a6ac', title='Test Entry',... 6, 50, 914689), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 914698), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_mixed_content_priority(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test that markdown_content takes priority over content."""
    update_data = {
        "markdown_content": "# Markdown wins",
        "content": "<p>HTML loses</p>"  # This should be ignored
    }

    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update_data,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:329: AssertionError
\_\_\_\_\_\_\_ TestEntriesQuality.test\_sequential\_updates\_maintain\_consistency \_\_\_\_\_\_\_\_
\[gw7] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_entries\_quality.TestEntriesQuality object at 0x7f6a18395810>
client = \<httpx.AsyncClient object at 0x7f6a085850f0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.WW\_S7OtWnJ2kwD7DL5fCNLVfsBaz8VuOMs-IkeAo9iU'}
sample\_entry = Entry(id='80a8455e-0ff7-488d-9910-32c710f7430c', author\_id='9c2b08aa-037b-4c5f-9b90-643f2026c9f9', title='Test Entry',... 6, 50, 958296), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 50, 958313), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_sequential_updates_maintain_consistency(
    self, client: AsyncClient, auth_headers: dict[str, str], sample_entry: Entry
):
    """Test that sequential updates maintain data consistency."""
    entry_id = str(sample_entry.id)

    # Sequential updates to avoid session conflicts
    # Update title first
    title_response = await client.put(
        f"/api/v1/entries/{entry_id}",
        json={"title": "Updated Title"},
        headers=auth_headers
    )
```

> ```
>   assert title_response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_entries\_quality.py:73: AssertionError
\_\_\_\_\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_markdown\_with\_lists \_\_\_\_\_\_\_\_\_
\[gw11] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7fd3b04d1370>
client = \<httpx.AsyncClient object at 0x7fd3986d4a70>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}
sample\_entry = Entry(id='fef40f31-e853-4ff2-8dfc-42d6d9929e41', author\_id='15a11f23-fbe9-4eca-a867-f2ab81f3f104', title='Test Entry',...3, 6, 51, 18163), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 51, 18178), char\_count=0, version=1, is\_deleted=False)

```
    @pytest.mark.asyncio
    async def test_update_entry_markdown_with_lists(
        self,
        client: AsyncClient,
        auth_headers: dict[str, str],
        sample_entry: Entry
    ):
        """Test markdown with lists converts properly."""
        update_data = {
            "markdown_content": """# Lists

Unordered:
    - Item 1
    - Item 2
        - Nested item
    - Item 3

Ordered:
    1. First
    2. Second
    3. Third
"""
        }

        response = await client.put(
            f"/api/v1/entries/{sample_entry.id}",
            json=update_data,
            headers=auth_headers
        )
```

> ```
>       assert response.status_code == 200
> ```

E           assert 422 == 200
E            +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:177: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPIErrors.test\_update\_entry\_invalid\_uuid \_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw3] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_errors.TestEntriesAPIErrors object at 0x7f70602c0710>
client = \<httpx.AsyncClient object at 0x7f7048461010>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}

```
@pytest.mark.asyncio
async def test_update_entry_invalid_uuid(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test updating entry with invalid UUID format."""
    response = await client.put(
        "/api/v1/entries/not-a-uuid",
        json={"title": "Test"},
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 404  # Invalid UUID treated as not found
> ```

```
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
```

E       assert 422 == 404
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_errors.py:134: AssertionError
\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_markdown\_special\_characters \_\_\_\_\_
\[gw2] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7f7af053b250>
client = \<httpx.AsyncClient object at 0x7f7ae079e210>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}
sample\_entry = Entry(id='462265c7-c4f0-4944-adf5-8059d496601f', author\_id='e99811de-6390-4e44-aa44-552b81cba28f', title='Test Entry',...3, 6, 51, 95624), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 51, 95635), char\_count=0, version=1, is\_deleted=False)

```
    @pytest.mark.asyncio
    async def test_update_entry_markdown_special_characters(
        self,
        client: AsyncClient,
        auth_headers: dict[str, str],
        sample_entry: Entry
    ):
        """Test markdown with special characters and escaping."""
        update_data = {
            "markdown_content": """# Special & Characters

This has <angle> brackets & ampersands.

Also "quotes" and 'apostrophes'.

Math: 5 < 10 && 10 > 5
"""
        }

        response = await client.put(
            f"/api/v1/entries/{sample_entry.id}",
            json=update_data,
            headers=auth_headers
        )
```

> ```
>       assert response.status_code == 200
> ```

E           assert 422 == 200
E            +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:265: AssertionError
\_\_\_\_\_\_\_\_ TestEntriesDeleteAPI.test\_delete\_entry\_different\_user\_allowed \_\_\_\_\_\_\_\_\_
\[gw9] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_delete.TestEntriesDeleteAPI object at 0x7f590c126950>
client = \<httpx.AsyncClient object at 0x7f5904382030>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}
db\_session = \<sqlalchemy.orm.session.AsyncSession object at 0x7f59044bf390>

```
@pytest.mark.asyncio
async def test_delete_entry_different_user_allowed(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    db_session: AsyncSession
):
    """Test that any authenticated user can delete any entry (current behavior)."""
    # Create entry by different user
    entry = Entry(
        title="Other user's entry",
        content="Content",
        author_id="22222222-2222-2222-2222-222222222222"  # Different user
    )
    db_session.add(entry)
    await db_session.commit()

    # Current user can still delete it (no ownership check currently)
    response = await client.delete(
        f"/api/v1/entries/{entry.id}",
        headers=auth_headers
    )

    # This should succeed in current implementation
```

> ```
>   assert response.status_code == 204
> ```

E       assert 422 == 204
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_delete.py:198: AssertionError
\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_with\_markdown\_sets\_version \_\_\_\_\_\_
\[gw6] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7ff018789090>
client = \<httpx.AsyncClient object at 0x7ff018266c30>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}
sample\_entry = Entry(id='74e2c4ba-008f-428a-ae54-cbeb8194a80c', author\_id='998a138f-0877-49ca-bc73-180d92872487', title='Test Entry',... 6, 51, 195194), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 51, 195220), char\_count=0, version=1, is\_deleted=False)
db\_session = \<sqlalchemy.orm.session.AsyncSession object at 0x7ff0181f5310>

```
@pytest.mark.asyncio
async def test_update_entry_with_markdown_sets_version(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry,
    db_session: AsyncSession
):
    """Test that updating with markdown_content sets content_version to 2."""
    update_data = {
        "markdown_content": "# Updated Title\n\nThis is **bold** text with a [link](https://example.com)"
    }

    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update_data,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:34: AssertionError
\_\_\_\_\_\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_null\_markdown\_allowed \_\_\_\_\_\_\_\_
\[gw0] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7f1fd82557c0>
client = \<httpx.AsyncClient object at 0x7f1fc848cef0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}
sample\_entry = Entry(id='8f4c2189-4609-4e1a-bfe6-d4b6442c1869', author\_id='8fc49b20-7b36-4919-b557-01e45fea62dc', title='Test Entry',... 6, 51, 217437), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 51, 217449), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_null_markdown_allowed(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test that null markdown_content is allowed."""
    # First set markdown content
    update1 = {"markdown_content": "# Has content"}
    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update1,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:352: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPIErrors.test\_delete\_entry\_invalid\_uuid \_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw3] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_errors.TestEntriesAPIErrors object at 0x7f70602897b0>
client = \<httpx.AsyncClient object at 0x7f7048471590>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}

```
@pytest.mark.asyncio
async def test_delete_entry_invalid_uuid(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str]
):
    """Test deleting entry with invalid UUID format."""
    response = await client.delete(
        "/api/v1/entries/not-a-uuid",
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 404  # Invalid UUID treated as not found
> ```

```
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
```

E       assert 422 == 404
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_errors.py:147: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesAPIErrors.test\_update\_entry\_empty\_data \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw10] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_errors.TestEntriesAPIErrors object at 0x7f57706a4cd0>
client = \<httpx.AsyncClient object at 0x7f57701947c0>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}
sample\_entry = Entry(id='732a461c-e078-4566-af55-32550f819783', author\_id='93f5ee6a-bd16-4810-bba5-dc5160c95072', title='Test Entry',... 6, 51, 500016), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 51, 500047), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_empty_data(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test updating entry with empty data."""
    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json={},
        headers=auth_headers
    )
    # Should succeed but not change anything
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_errors.py:67: AssertionError
\_\_\_ TestEntriesMarkdownAPI.test\_update\_entry\_markdown\_with\_explicit\_version \_\_\_\_
\[gw6] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_api\_entries\_markdown.TestEntriesMarkdownAPI object at 0x7ff0187891d0>
client = \<httpx.AsyncClient object at 0x7ff018260e20>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}
sample\_entry = Entry(id='96e193ad-aba3-4875-9f20-b2260247f0a7', author\_id='2a0bb3bf-b93e-4b3a-9ad2-1c02d7e28d0b', title='Test Entry',... 6, 51, 654902), updated\_at=datetime.datetime(2025, 9, 3, 3, 6, 51, 654919), char\_count=0, version=1, is\_deleted=False)

```
@pytest.mark.asyncio
async def test_update_entry_markdown_with_explicit_version(
    self,
    client: AsyncClient,
    auth_headers: dict[str, str],
    sample_entry: Entry
):
    """Test updating markdown with explicit content_version."""
    update_data = {
        "markdown_content": "Simple markdown",
        "content_version": 3  # Custom version
    }

    response = await client.put(
        f"/api/v1/entries/{sample_entry.id}",
        json=update_data,
        headers=auth_headers
    )
```

> ```
>   assert response.status_code == 200
> ```

E       assert 422 == 200
E        +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_api\_entries\_markdown.py:67: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_ TestEntriesQuality.test\_special\_characters\_in\_content \_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw8] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_entries\_quality.TestEntriesQuality object at 0x7fde8011f650>
client = \<httpx.AsyncClient object at 0x7fde783b0180>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.DcfrAQs9lv19LoNgLpJ9Zen1qlDtgoU92sDfdiAVuXs'}

```
    @pytest.mark.asyncio
    async def test_special_characters_in_content(
        self, client: AsyncClient, auth_headers: dict[str, str]
    ):
        """Test that special characters are handled correctly."""
        special_content = {
            "title": "Special < > & \" ' Characters",
            "markdown_content": """
# Special & Characters < > " '

Code with special chars: `const a = "<div>&nbsp;</div>";`

URL: https://example.com?foo=bar&baz=qux

Math: $x < y > z$

Emoji:   
"""
        }

        response = await client.post(
            "/api/v1/entries",
            json=special_content,
            headers=auth_headers
        )
        assert response.status_code == 201
        data = response.json()

        # Verify special characters are preserved/escaped properly
```

> ```
>       assert "&" in data["content"] or "&amp;" in data["content"]
> ```

E           AssertionError: assert ('&' in '' or '&' in '')

tests/api/test\_entries\_quality.py:307: AssertionError
\_\_\_\_\_\_\_\_\_\_\_ TestEntriesQuality.test\_entry\_lifecycle\_with\_soft\_delete \_\_\_\_\_\_\_\_\_\_\_
\[gw5] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_entries\_quality.TestEntriesQuality object at 0x7fd44817dd00>
client = \<httpx.AsyncClient object at 0x7fd440381250>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.vBnAf5DrM6xs98fQzMZ-wcviruZb-\_L1CjXdpuwuxjg'}

```
@pytest.mark.asyncio
async def test_entry_lifecycle_with_soft_delete(
    self, client: AsyncClient, auth_headers: dict[str, str]
):
    """Test complete entry lifecycle including soft delete behavior."""
    # Create
    create_response = await client.post(
        "/api/v1/entries",
        json={"title": "Lifecycle Test", "content": "Test content"},
        headers=auth_headers
    )
    assert create_response.status_code == 201
    entry_id = create_response.json()["id"]

    # Update multiple times
    for i in range(3):
        update_response = await client.put(
            f"/api/v1/entries/{entry_id}",
            json={"title": f"Update {i+1}"},
            headers=auth_headers
        )
```

> ```
>       assert update_response.status_code == 200
> ```

E           assert 422 == 200
E            +  where 422 = \<Response \[422 Unprocessable Entity]>.status\_code

tests/api/test\_entries\_quality.py:218: AssertionError
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ TestSearchQuality.test\_semantic\_search\_relevance \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
\[gw8] linux -- Python 3.13.7 /home/verlyn13/Projects/verlyn13/journal/apps/api/.venv/bin/python3

self = \<test\_search\_quality.TestSearchQuality object at 0x7fde8019dbd0>
client = \<httpx.AsyncClient object at 0x7fde781df410>
auth\_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJqb3VybmFsLWFwaSIsImF1ZCI6ImpvdXJuYWwtY2xpZW5...U4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsInNjb3BlIjoiIiwidHlwIjoiYWNjZXNzIn0.vBnAf5DrM6xs98fQzMZ-wcviruZb-\_L1CjXdpuwuxjg'}
db\_session = \<sqlalchemy.orm.session.AsyncSession object at 0x7fde783139d0>

```
@pytest.mark.asyncio
async def test_semantic_search_relevance(
    self, client: AsyncClient, auth_headers: dict[str, str], db_session: AsyncSession
):
    """Test that semantic search returns relevant results."""
    # Create entries with different topics
    entries = [
        {"title": "Machine Learning Basics", "content": "Neural networks, deep learning, and AI fundamentals"},
        {"title": "Cooking Recipe", "content": "How to make pasta with tomato sauce"},
        {"title": "Python Programming", "content": "Writing code, functions, and object-oriented programming"},
        {"title": "AI and Future", "content": "Artificial intelligence will transform how we work"},
    ]

    created_ids = []
    for entry_data in entries:
        response = await client.post(
            "/api/v1/entries",
            json=entry_data,
            headers=auth_headers
        )
        assert response.status_code == 201
        created_ids.append(response.json()["id"])

    # Generate embeddings for all entries (required for semantic search)
    for entry_id in created_ids:
        embed_response = await client.post(
            f"/api/v1/search/entries/{entry_id}/embed",
            headers=auth_headers
        )
```

> ```
>       assert embed_response.status_code == 200
> ```

E           assert 404 == 200
E            +  where 404 = \<Response \[404 Not Found]>.status\_code

tests/api/test\_search\_quality.py:46: AssertionError
\=========================== short test summary info ============================
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_invalid\_uuid
FAILED tests/api/test\_api\_entries.py::TestEntriesAPI::test\_delete\_entry\_success
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_success
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_soft\_delete
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_with\_embedding
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_updates\_is\_deleted\_flag
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_html\_preserves\_version
FAILED tests/api/test\_api\_entries.py::TestEntriesAPI::test\_delete\_entry\_not\_found
FAILED tests/api/test\_api\_entries\_errors.py::TestEntriesAPIErrors::test\_update\_entry\_markdown\_conversion
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_markdown\_with\_images
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_prefer\_markdown\_header
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_idempotent
FAILED tests/api/test\_entries\_quality.py::TestEntriesQuality::test\_update\_entry\_preserves\_data\_integrity\_with\_partial\_updates
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_markdown\_with\_code\_blocks
FAILED tests/api/test\_entries\_quality.py::TestEntriesQuality::test\_content\_length\_tracking
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_deleted\_entry\_not\_in\_list
FAILED tests/api/test\_api\_entries\_errors.py::TestEntriesAPIErrors::test\_update\_entry\_html\_conversion
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_empty\_markdown
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_mixed\_content\_priority
FAILED tests/api/test\_entries\_quality.py::TestEntriesQuality::test\_sequential\_updates\_maintain\_consistency
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_markdown\_with\_lists
FAILED tests/api/test\_api\_entries\_errors.py::TestEntriesAPIErrors::test\_update\_entry\_invalid\_uuid
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_markdown\_special\_characters
FAILED tests/api/test\_api\_entries\_delete.py::TestEntriesDeleteAPI::test\_delete\_entry\_different\_user\_allowed
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_with\_markdown\_sets\_version
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_null\_markdown\_allowed
FAILED tests/api/test\_api\_entries\_errors.py::TestEntriesAPIErrors::test\_delete\_entry\_invalid\_uuid
FAILED tests/api/test\_api\_entries\_errors.py::TestEntriesAPIErrors::test\_update\_entry\_empty\_data
FAILED tests/api/test\_api\_entries\_markdown.py::TestEntriesMarkdownAPI::test\_update\_entry\_markdown\_with\_explicit\_version
FAILED tests/api/test\_entries\_quality.py::TestEntriesQuality::test\_special\_characters\_in\_content
FAILED tests/api/test\_entries\_quality.py::TestEntriesQuality::test\_entry\_lifecycle\_with\_soft\_delete
FAILED tests/api/test\_search\_quality.py::TestSearchQuality::test\_semantic\_search\_relevance
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 32 failures !!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!! xdist.dsession.Interrupted: stopping after 10 failures !!!!!!!!!!!!
\======================== 32 failed, 44 passed in 16.52s ========================
